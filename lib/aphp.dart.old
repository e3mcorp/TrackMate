// lib/app.dart
import 'package:flutter/material.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:provider/provider.dart';
import 'package:trackmate/locale/app_localizations.dart';
import 'package:trackmate/data/settings.dart';
import 'package:trackmate/screens/splash_screen.dart';
import 'package:trackmate/themes.dart';

class App extends StatelessWidget {
  const App({super.key});

  @override
  Widget build(BuildContext context) {
    // ✅ USA SOLO Settings (rimuovi LocaleManager)
    return Consumer<Settings>(
      builder: (context, settings, child) {
        return MaterialApp(
          debugShowCheckedModeBanner: false,

          // ✅ CRUCIALE: Collega il locale dal Settings
          locale: settings.locale,

          // ✅ Delegates necessari
          localizationsDelegates: const [
            AppLocalizations.delegate,
            GlobalMaterialLocalizations.delegate,
            GlobalWidgetsLocalizations.delegate,
            GlobalCupertinoLocalizations.delegate,
          ],

          // ✅ Lingue supportate
          supportedLocales: AppLocalizations.supportedLocales,

          // ✅ Fallback robusto
          localeResolutionCallback: (locale, supportedLocales) {
            if (locale == null) return const Locale('en', 'US');

            // Exact match
            for (var supportedLocale in supportedLocales) {
              if (supportedLocale.languageCode == locale.languageCode &&
                  supportedLocale.countryCode == locale.countryCode) {
                return supportedLocale;
              }
            }

            // Language match
            for (var supportedLocale in supportedLocales) {
              if (supportedLocale.languageCode == locale.languageCode) {
                return supportedLocale;
              }
            }

            return const Locale('en', 'US');
          },

          // ✅ Tema dal Settings
          themeMode: settings.theme,
          theme: Themes.lightTheme,
          darkTheme: Themes.darkTheme,

          home: const SplashScreen(),
        );
      },
    );
  }
}
